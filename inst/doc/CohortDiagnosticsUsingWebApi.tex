% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Running cohort diagnostics using WebAPI},
  pdfauthor={Martijn J. Schuemie},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}

\title{Running cohort diagnostics using WebAPI}
\author{Martijn J. Schuemie}
\date{2020-08-06}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{2}
\tableofcontents
}
\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

This vignette describes how one could use the CohortDiagnostics R
package, using the OHDSI WebAPI to access cohort definitions.

The CohortDiagnostics package allows one to generate a wide set of
diagnostics to evaluate cohort definitions against a database in the
Common Data Model (CDM). These diagnostics include incidence rates
(optionally stratified by age, gender, and calendar year), cohort
characteristics (comorbidities, drug use, etc.), and the codes found in
the data triggering the various rules in the cohort definitions.

The CohortDiagnostics package in general works in two steps:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Generate the diagnostics against a database in the CDM.
\item
  Explore the generated diagnostics in a Shiny app included in the
  CohortDiagnostics package.
\end{enumerate}

There are currently two approaches one can take to step 1: The cohort
diagnostics can be embedded in an OHDSI study package, where all the
cohort definitions are stored as part of that study package, or the
cohort diagnostics can be used as a stand-alone solution, relying on a
WebAPI instance to provide the cohort definitions. WebAPI is the backend
of the OHDSI ATLAS application, allowing programmatic access to the
cohort definitions created in ATLAS. This vignette describes the latter
approach: how to run CohortDiagnostics using the WebAPI.

\hypertarget{running-the-cohort-diagnostics}{%
\section{Running the cohort
diagnostics}\label{running-the-cohort-diagnostics}}

\hypertarget{defining-the-set-of-cohorts-to-diagnose}{%
\subsection{Defining the set of cohorts to
diagnose}\label{defining-the-set-of-cohorts-to-diagnose}}

The first step is to define the set of cohorts we wish to create
diagnostics for. We do this by creating a data frame with four columns:

\begin{itemize}
\tightlist
\item
  \textbf{atlasId}: The cohort ID in ATLAS.
\item
  \textbf{atlasName}: The full name of the cohort. This will be shown in
  the Shiny app.
\item
  \textbf{cohortId}: The cohort ID to use in the package. Usually the
  same as the cohort ID in ATLAS.
\item
  \textbf{name}: A short name for the cohort, to use to create file
  names. do not use special characters.
\end{itemize}

A convenient way to create such a data frame is to create a CSV file,
and load it into R. Here is an example table we assume is stored in
\texttt{cohortsToDiagnose.csv}:

\begin{longtable}[]{@{}rlrl@{}}
\toprule
\begin{minipage}[b]{0.15\columnwidth}\raggedleft
atlasId\strut
\end{minipage} & \begin{minipage}[b]{0.28\columnwidth}\raggedright
atlasName\strut
\end{minipage} & \begin{minipage}[b]{0.17\columnwidth}\raggedleft
cohortId\strut
\end{minipage} & \begin{minipage}[b]{0.28\columnwidth}\raggedright
name\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.15\columnwidth}\raggedleft
1770710\strut
\end{minipage} & \begin{minipage}[t]{0.28\columnwidth}\raggedright
New users of ACE inhibitors as first-line monotherapy for
hypertension\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\raggedleft
1770710\strut
\end{minipage} & \begin{minipage}[t]{0.28\columnwidth}\raggedright
ace\_inhibitors\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\raggedleft
1770711\strut
\end{minipage} & \begin{minipage}[t]{0.28\columnwidth}\raggedright
New users of Thiazide-like diuretics as first-line monotherapy for
hypertension\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\raggedleft
1770711\strut
\end{minipage} & \begin{minipage}[t]{0.28\columnwidth}\raggedright
thz\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\raggedleft
1770712\strut
\end{minipage} & \begin{minipage}[t]{0.28\columnwidth}\raggedright
Angioedema outcome\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\raggedleft
1770712\strut
\end{minipage} & \begin{minipage}[t]{0.28\columnwidth}\raggedright
angioedema\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.15\columnwidth}\raggedleft
1770713\strut
\end{minipage} & \begin{minipage}[t]{0.28\columnwidth}\raggedright
Acute myocardial infarction outcome\strut
\end{minipage} & \begin{minipage}[t]{0.17\columnwidth}\raggedleft
1770713\strut
\end{minipage} & \begin{minipage}[t]{0.28\columnwidth}\raggedright
ami\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

We can read the table using

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(CohortDiagnostics)}
\NormalTok{cohortSetReference <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"cohortsToDiagnose.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{configuring-the-connection-to-the-server}{%
\subsection{Configuring the connection to the
server}\label{configuring-the-connection-to-the-server}}

We need to tell R how to connect to the server where the data are.
\texttt{CohortDiagnostics} uses the \texttt{DatabaseConnector} package,
which provides the \texttt{createConnectionDetails} function. Type
\texttt{?createConnectionDetails} for the specific settings required for
the various database management systems (DBMS). For example, one might
connect to a PostgreSQL database using this code:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{connectionDetails <-}\StringTok{ }\KeywordTok{createConnectionDetails}\NormalTok{(}\DataTypeTok{dbms =} \StringTok{"postgresql"}\NormalTok{,}
                                             \DataTypeTok{server =} \StringTok{"localhost/ohdsi"}\NormalTok{,}
                                             \DataTypeTok{user =} \StringTok{"joe"}\NormalTok{,}
                                             \DataTypeTok{password =} \StringTok{"supersecret"}\NormalTok{)}

\NormalTok{cdmDatabaseSchema <-}\StringTok{ "my_cdm_data"}
\NormalTok{oracleTempSchema <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{cohortDatabaseSchema <-}\StringTok{ "my_schema"}
\NormalTok{cohortTable <-}\StringTok{ "my_cohort_table"}
\end{Highlighting}
\end{Shaded}

The last four lines define the \texttt{cdmDatabaseSchema},
\texttt{oracleTempSchema}, \texttt{cohortDatabaseSchema}, and
\texttt{cohortTable} variables. We'll use the \texttt{cdmDatabaseSchema}
later to tell R where the data in CDM format live. The
\texttt{oracleTempSchema} is needed only for Oracle users, since Oracle
does not support temporary tables. The \texttt{cohortDatabaseSchema},
and \texttt{cohortTable} specify where we want to instantiate our
cohorts. Note that for Microsoft SQL Server, databaseschemas need to
specify both the database and the schema, so for example
\texttt{cdmDatabaseSchema\ \textless{}-\ "my\_cdm\_data.dbo"}.

\hypertarget{creating-a-new-cohort-table}{%
\subsection{Creating a new cohort
table}\label{creating-a-new-cohort-table}}

In order to run most of the cohort diagnostics, we need to instantiate
the cohorts. The best way is to instantiate the cohorts in a new cohort
table. We can use the \texttt{createCohortTable} to create an empty
cohort table:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{createCohortTable}\NormalTok{(}\DataTypeTok{connectionDetails =}\NormalTok{ connectionDetails,}
                  \DataTypeTok{cohortDatabaseSchema =}\NormalTok{ cohortDatabaseSchema,}
                  \DataTypeTok{cohortTable =}\NormalTok{ cohortTable)}
\end{Highlighting}
\end{Shaded}

Note this this function will \textbf{delete the table if it already
exists} before creating it.

\hypertarget{instantiating-the-cohorts}{%
\subsection{Instantiating the cohorts}\label{instantiating-the-cohorts}}

Next, we will instantiate the cohorts we specified in the
\texttt{cohortSetReference} described earlier. To do this, we need to
communicate with the WebAPI instance, as well as the database server.

To connect to the WebAPI, we need to provide the base URL. This is a URL
that looks something like ``\url{http://server.org:80/WebAPI}''. If you
do not know the WebAPI's base URL, contact the ATLAS administrator.

We have the option to also generate inclusion rule statistics while the
cohorts are instantiated (recommended). If we want to do this, we need
to provide a folder where the inclusion rule statistics will be stored
for later use.

To instantiate the cohorts:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{baseUrl <-}\StringTok{ "http://server.org:80/WebAPI"}
\NormalTok{inclusionStatisticsFolder <-}\StringTok{ "c:/temp/incStats/"}

\KeywordTok{instantiateCohortSet}\NormalTok{(}\DataTypeTok{connectionDetails =}\NormalTok{ connectionDetails,}
                     \DataTypeTok{cdmDatabaseSchema =}\NormalTok{ cdmDatabaseSchema,}
                     \DataTypeTok{oracleTempSchema =}\NormalTok{ oracleTempSchema,}
                     \DataTypeTok{cohortDatabaseSchema =}\NormalTok{ cohortDatabaseSchema,}
                     \DataTypeTok{cohortTable =}\NormalTok{ cohortTable,}
                     \DataTypeTok{baseUrl =}\NormalTok{ baseUrl,}
                     \DataTypeTok{cohortSetReference =}\NormalTok{ cohortSetReference,}
                     \DataTypeTok{generateInclusionStats =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{inclusionStatisticsFolder =}\NormalTok{ inclusionStatisticsFolder)}
\end{Highlighting}
\end{Shaded}

This command will contact the WebApi to obtain the cohort definitions,
instantiate them in the cohort table, and write the inclusion rule
statistics to the specified folder.

\hypertarget{generating-the-diagnostics}{%
\subsection{Generating the
diagnostics}\label{generating-the-diagnostics}}

Next we generate the cohort diagnostics:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{databaseId <-}\StringTok{ "MyData"}
\NormalTok{exportFolder <-}\StringTok{ "c:/temp/export"}

\KeywordTok{runCohortDiagnostics}\NormalTok{(}\DataTypeTok{baseUrl =}\NormalTok{ baseUrl,}
                     \DataTypeTok{cohortSetReference =}\NormalTok{ cohortSetReference,}
                     \DataTypeTok{connectionDetails =}\NormalTok{ connectionDetails,}
                     \DataTypeTok{cdmDatabaseSchema =}\NormalTok{ cdmDatabaseSchema,}
                     \DataTypeTok{oracleTempSchema =}\NormalTok{ oracleTempSchema,}
                     \DataTypeTok{cohortDatabaseSchema =}\NormalTok{ cohortDatabaseSchema,}
                     \DataTypeTok{cohortTable =}\NormalTok{ cohortTable,}
                     \DataTypeTok{inclusionStatisticsFolder =}\NormalTok{ inclusionStatisticsFolder,}
                     \DataTypeTok{exportFolder =}\NormalTok{ exportFolder,}
                     \DataTypeTok{databaseId =}\NormalTok{ databaseId,}
                     \DataTypeTok{runInclusionStatistics =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{runIncludedSourceConcepts =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{runOrphanConcepts =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{runTimeDistributions =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{runBreakdownIndexEvents =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{runIncidenceRate =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{runCohortOverlap =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{runCohortCharacterization =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{minCellCount =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The databaseId is a short string that will be used to identify the data
from this database in the Shiny app. Make sure to give it a name you can
easily recognize.

Once completed, a zip file will have been created in the specified
export folder. This zip file can be shared between sites, as it does not
contain patient-identifiable information. Note that cell counts smaller
than 5 have been removed, as specified using the \texttt{minCellCount}
argument, to ensure non-identifiability.

\hypertarget{viewing-the-diagnostics}{%
\section{Viewing the diagnostics}\label{viewing-the-diagnostics}}

Assuming you completed the steps described above for one or more
databases, you should now have a set of zip files, one per database.
Make sure to place all zip files in a single folder, for example
\texttt{c:/temp/allZipFiles}.

Optionally, we can pre-merge the zip files. Merging the files can take a
while, and doing it beforehand will speed up starting the Shiny app:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{preMergeDiagnosticsFiles}\NormalTok{(}\StringTok{"C:/temp/allZipFiles"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

To view the diagnostics, use

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{launchDiagnosticsExplorer}\NormalTok{(}\StringTok{"C:/temp/allZipFiles"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

This will launch the Shiny app shown below:

\begin{figure}
\centering
\includegraphics{shiny.png}
\caption{The Diagnostics Explorer Shiny app}
\end{figure}

Note that each of the tabs on the left has an information icon. Clicking
on these icons will show additional information on each diagnostic, how
they were computed, and how they should be interpreted.

\hypertarget{deploying-the-shiny-app-on-a-shiny-server}{%
\subsection{Deploying the Shiny app on a Shiny
Server}\label{deploying-the-shiny-app-on-a-shiny-server}}

To share the results with others, it may make sense to make the Shiny
app available through a Shiny Server. On the Shiny Server, a folder
should be created for the app. The following should be placed in this
folder:

\begin{itemize}
\item
  The Shiny app itself. This can be found
  \href{https://github.com/OHDSI/CohortDiagnostics/tree/master/inst/shiny/DiagnosticsExplorer}{here}.
  Make sure to copy all files in the \texttt{DiagnosticsExplorer}
  folder.
\item
  The diagnostics data should be placed in a subfolder that should be
  called \texttt{data}. In this data folder, either place all the
  individual zip files generated for each database, or (recommended)
  place the premerged .RDA file here.
\end{itemize}

Once the app and data are in place, the Shiny Server should
automatically detect them and launch the app. You may need to install
additional packages required by the app, including `shinydashboard',
`VennDiagram', `htmltools', and `DT'.

\end{document}
