addInfo <- function(item, infoId) {
  infoTag <- tags$small(
    class = "badge pull-right action-button",
    style = "padding: 1px 6px 2px 6px; background-color: steelblue;",
    type = "button",
    id = infoId,
    "i"
  )
  item$children[[1]]$children <-
    append(item$children[[1]]$children, list(infoTag))
  return(item)
}

cohortReference <- function(outputId) {
  shinydashboard::box(
    # title = "Reference",
    status = "warning",
    width = "100%",
    tags$div(style = "max-height: 100px; overflow-y: auto",
             shiny::uiOutput(outputId = outputId))
  )
}

cohortReferenceWithDatabaseId <- function(cohortOutputId, databaseOutputId) {
  shinydashboard::box(
    # title = "Reference",
    status = "warning",
    width = "100%",
    tags$div(style = "max-height: 100px; overflow-y: auto",
             tags$table(width = "100%",
                        tags$tr(
                          tags$td(width = "70%",
                                  tags$b("Cohorts :"),
                                  shiny::uiOutput(outputId = cohortOutputId)
                          ),
                          tags$td(style = "align: right !important;", width = "30%",
                                  tags$b("Database :"),
                                  shiny::uiOutput(outputId = databaseOutputId)
                          )
                        )
             )
    )
  )
}

if (is(dataSource, "environment")) {
  choicesFordatabaseOrVocabularySchema <-
    c(database$databaseIdWithVocabularyVersion)
} else {
  choicesFordatabaseOrVocabularySchema <- list(
    'From data source' = database$databaseIdWithVocabularyVersion,
    'Reference Vocabulary' = vocabularyDatabaseSchemas
  )
}

header <-
  shinydashboard::dashboardHeader(title = "Cohort Diagnostics")

sidebarMenu <-
  shinydashboard::sidebarMenu(
    id = "tabs",
    if (exists("cohort"))
      shinydashboard::menuItem(text = "Cohort Definition", tabName = "cohortDefinition"),
    if (exists("includedSourceConcept"))
      addInfo(
        item = shinydashboard::menuItem(text = "Concepts in Data Source", tabName = "includedConcepts"),
        infoId = "includedConceptsInfo"
      ),
    if (exists("orphanConcept"))
      addInfo(
        item = shinydashboard::menuItem(text = "Orphan Concepts", tabName = "orphanConcepts"),
        infoId = "orphanConceptsInfo"
      ),
    if (exists("cohortCount"))
      addInfo(
        item = shinydashboard::menuItem(text = "Cohort Counts", tabName = "cohortCounts"),
        infoId = "cohortCountsInfo"
      ),
    if (exists("incidenceRate"))
      addInfo(
        item = shinydashboard::menuItem(text = "Incidence Rate", tabName = "incidenceRate"),
        infoId = "incidenceRateInfo"
      ),
    if (exists("timeSeries"))
      addInfo(
        item = shinydashboard::menuItem(text = "Time Series", tabName = "timeSeries"),
        infoId = "timeSeriesInfo"
      ),
    if (exists("timeDistribution"))
      addInfo(
        item = shinydashboard::menuItem(text = "Time Distributions", tabName = "timeDistribution"),
        infoId = "timeDistributionInfo"
      ),
    # if (exists("inclusionRuleStats"))
    #   addInfo(
    #     item = shinydashboard::menuItem(text = "Inclusion Rule Statistics", tabName = "inclusionRuleStats"),
    #     infoId = "inclusionRuleStatsInfo"
    #   ),
    if (exists("indexEventBreakdown"))
      addInfo(
        item = shinydashboard::menuItem(text = "Index Event Breakdown", tabName = "indexEventBreakdown"),
        infoId = "indexEventBreakdownInfo"
      ),
    if (exists("visitContext"))
      addInfo(
        item = shinydashboard::menuItem(text = "Visit Context", tabName = "visitContext"),
        infoId = "visitContextInfo"
      ),
    if (exists("cohortOverlap"))
      addInfo(
        shinydashboard::menuItem(text = "Cohort Overlap", tabName = "cohortOverlap"),
        infoId = "cohortOverlapInfo"
      ),
    if (exists("covariateValue"))
      addInfo(
        shinydashboard::menuItem(text = "Cohort Characterization", tabName = "cohortCharacterization"),
        infoId = "cohortCharacterizationInfo"
      ),
    if (exists("temporalCovariateValue"))
      addInfo(
        shinydashboard::menuItem(text = "Temporal Characterization", tabName = "temporalCharacterization"),
        infoId = "temporalCharacterizationInfo"
      ),
    if (exists("covariateValue"))
      addInfo(
        item = shinydashboard::menuItem(text = "Compare Cohort Char.", tabName = "compareCohortCharacterization"),
        infoId = "compareCohortCharacterizationInfo"
      ),
    if (exists("temporalCovariateValue"))
      addInfo(
        shinydashboard::menuItem(text = "Compare Temporal Char.", tabName = "compareTemporalCharacterization"),
        infoId = "compareTemporalCharacterizationInfo"
      ),
    shinydashboard::menuItem(text = "Data Source Information", tabName = "databaseInformation"),
    # Conditional dropdown boxes in the side bar ------------------------------------------------------
    shiny::conditionalPanel(
      condition = "input.tabs!='incidenceRate' &
      input.tabs != 'timeSeries' &
      input.tabs != 'timeDistribution' &
      input.tabs != 'cohortCharacterization' &
      input.tabs != 'cohortCounts' &
      input.tabs != 'indexEventBreakdown' &
      input.tabs != 'databaseInformation' &
      input.tabs != 'cohortDefinition' &
      input.tabs != 'includedConcepts' &
      input.tabs != 'orphanConcepts' &
      input.tabs != 'inclusionRuleStats' &
      input.tabs != 'visitContext' &
      input.tabs != 'cohortOverlap'",
      shinyWidgets::pickerInput(
        inputId = "database",
        label = "Database",
        choices = database$databaseId,
        selected = database$databaseId[1],
        multiple = FALSE,
        choicesOpt = list(style = rep_len("color: black;", 999)),
        options = shinyWidgets::pickerOptions(
          actionsBox = TRUE,
          liveSearch = TRUE,
          size = 10,
          liveSearchStyle = "contains",
          liveSearchPlaceholder = "Type here to search",
          virtualScroll = 50
        )
      )
    ),
    shiny::conditionalPanel(
      condition = "input.tabs=='incidenceRate' |
      input.tabs =='timeSeries' |
      input.tabs == 'timeDistribution' |
      input.tabs =='cohortCharacterization' |
      input.tabs == 'cohortCounts' |
      input.tabs == 'indexEventBreakdown' |
      input.tabs == 'includedConcepts' |
      input.tabs == 'orphanConcepts' |
      input.tabs == 'inclusionRuleStats' |
      input.tabs == 'visitContext' |
      input.tabs == 'cohortOverlap'",
      shinyWidgets::pickerInput(
        inputId = "databases",
        label = "Database",
        choices = database$databaseId,
        selected = database$databaseId[1],
        multiple = TRUE,
        choicesOpt = list(style = rep_len("color: black;", 999)),
        options = shinyWidgets::pickerOptions(
          actionsBox = TRUE,
          liveSearch = TRUE,
          size = 10,
          liveSearchStyle = "contains",
          liveSearchPlaceholder = "Type here to search",
          virtualScroll = 50
        )
      )
    ),
    if (exists("temporalCovariateValue")) {
      shiny::conditionalPanel(
        condition = "input.tabs=='temporalCharacterization' | input.tabs =='compareTemporalCharacterization'",
        shinyWidgets::pickerInput(
          inputId = "timeIdChoices",
          label = "Temporal Choice",
          choices = temporalCovariateChoices$choices,
          multiple = TRUE,
          choicesOpt = list(style = rep_len("color: black;", 999)),
          selected = temporalCovariateChoices %>%
            dplyr::filter(stringr::str_detect(string = .data$choices,
                                              pattern = 'Start -365 to end -31|Start -30 to end -1|Start 0 to end 0|Start 1 to end 30|Start 31 to end 365')) %>% 
            dplyr::filter(.data$timeId %in% (
              c(
                min(temporalCovariateChoices$timeId),
                temporalCovariateChoices %>%
                  dplyr::pull(.data$timeId)
              ) %>%
                unique() %>%
                sort()
            )) %>%
            dplyr::pull("choices"),
          options = shinyWidgets::pickerOptions(
            actionsBox = TRUE,
            liveSearch = TRUE,
            size = 10,
            liveSearchStyle = "contains",
            liveSearchPlaceholder = "Type here to search",
            virtualScroll = 50
          )
        )
      )
    },
    shiny::conditionalPanel(
      condition = "input.tabs != 'databaseInformation' &
      input.tabs != 'cohortDefinition' &
      input.tabs != 'cohortCounts' &
      input.tabs != 'cohortOverlap'&
      input.tabs != 'incidenceRate' &
      input.tabs !='timeSeries' &
      input.tabs != 'timeDistribution'",
      shinyWidgets::pickerInput(
        inputId = "cohort",
        label = "Cohort",
        choices = c(""),
        multiple = FALSE,
        choicesOpt = list(style = rep_len("color: black;", 999)),
        options = shinyWidgets::pickerOptions(
          actionsBox = TRUE,
          liveSearch = TRUE,
          liveSearchStyle = "contains",
          size = 10,
          liveSearchPlaceholder = "Type here to search",
          virtualScroll = 50
        )
      )
    ),
    shiny::conditionalPanel(
      condition = "input.tabs == 'cohortCounts' |
      input.tabs == 'cohortOverlap' |
      input.tabs == 'incidenceRate' |
      input.tabs =='timeSeries' |
      input.tabs == 'timeDistribution'",
      shinyWidgets::pickerInput(
        inputId = "cohorts",
        label = "Cohorts",
        choices = c(""),
        selected = c(""),
        multiple = TRUE,
        choicesOpt = list(style = rep_len("color: black;", 999)),
        options = shinyWidgets::pickerOptions(
          actionsBox = TRUE,
          liveSearch = TRUE,
          liveSearchStyle = "contains",
          size = 10,
          dropupAuto = TRUE,
          liveSearchPlaceholder = "Type here to search",
          virtualScroll = 50
        )
      )
    ),
    shiny::conditionalPanel(
      condition = "input.tabs == 'compareCohortCharacterization'|
        input.tabs == 'compareTemporalCharacterization'",
      shinyWidgets::pickerInput(
        inputId = "comparatorCohort",
        label = "Comparator",
        choices = c(""),
        multiple = FALSE,
        choicesOpt = list(style = rep_len("color: black;", 999)),
        options = shinyWidgets::pickerOptions(
          actionsBox = TRUE,
          liveSearch = TRUE,
          liveSearchStyle = "contains",
          size = 10,
          dropupAuto = TRUE,
          liveSearchPlaceholder = "Type here to search",
          virtualScroll = 50
        )
      )
    ),
    shiny::conditionalPanel(
      condition = "input.tabs == 'cohortCharacterization' |
      input.tabs == 'compareCohortCharacterization' |
      input.tabs == 'temporalCharacterization' |
      input.tabs == 'compareTemporalCharacterization' |
      input.tabs == 'includedConcepts' |
      input.tabs == 'orphanConcepts'",
      shinyWidgets::pickerInput(
        inputId = "conceptSetsToFilterCharacterization",
        label = "Concept sets",
        choices = c(""),
        selected = c(""),
        multiple = TRUE,
        choicesOpt = list(style = rep_len("color: black;", 999)),
        options = shinyWidgets::pickerOptions(
          actionsBox = TRUE,
          liveSearch = TRUE,
          size = 10,
          liveSearchStyle = "contains",
          liveSearchPlaceholder = "Type here to search",
          virtualScroll = 50
        )
      )
    )
  )

#Side bar code
sidebar <-
  shinydashboard::dashboardSidebar(sidebarMenu, 
                                   width = NULL, 
                                   collapsed = FALSE
  )

# Body - items in tabs --------------------------------------------------
bodyTabItems <- shinydashboard::tabItems(
  shinydashboard::tabItem(tabName = "about",
                          if (exists("aboutText"))
                            HTML(aboutText)),
  shinydashboard::tabItem(
    tabName = "cohortDefinition",
    shinydashboard::box(
      width = NULL,
      status = "primary",
      column(6,tags$h4("Cohort Definition")),
      column(6,
             tags$table(width = "100%",
                        tags$tr(
                          tags$td(
                            align = "right",
                            shiny::downloadButton(
                              outputId = "saveCohortDefinitionButton",
                              label = NULL,
                              icon = shiny::icon("download"),
                              style = "margin-top: 5px; margin-bottom: 5px;"
                            )
                          )
                        ))),    
      DT::dataTableOutput(outputId = "cohortDefinitionTable"),
      shiny::uiOutput(outputId = "dynamicUIGenerationCohortDefinitionConceptsetsOne"),
      shiny::uiOutput(outputId = "dynamicUIGenerationCohortDefinitionConceptsetsTwo"),
      tags$br(),
      shiny::column(width = 12,
                    shiny::conditionalPanel(
                      condition = "output.cohortDefinitionCountOfSelectedRows == 2 &
                     input.conceptSetsType == 'Resolved (included)' &
                     input.conceptSetsTypeSecond == 'Resolved (included)'",
                      shiny::tabsetPanel(
                        id = "resolvedConceptDifference",
                        shiny::tabPanel(
                          title = "Present in left",
                          tags$br(),
                          DT::dataTableOutput(outputId = "resolvedConceptsPresentInLeft")
                        ),
                        shiny::tabPanel(
                          title = "Present in Right",
                          tags$br(),
                          DT::dataTableOutput(outputId = "resolvedConceptsPresentInRight")
                        ),
                        shiny::tabPanel(
                          title = "Present in Both",
                          tags$br(),
                          DT::dataTableOutput(outputId = "resolvedConceptsPresentInBoth")
                        ),
                        shiny::tabPanel(
                          title = "Present in Either",
                          tags$br(),
                          DT::dataTableOutput(outputId = "resolvedConceptsPresentInEither")
                        )
                      )
                    )),
      shiny::column(width = 12,
                    shiny::conditionalPanel(
                      condition = "output.cohortDefinitionCountOfSelectedRows == 2 &
                                   input.conceptSetsType == 'Mapped (source)' &
                                   input.conceptSetsTypeSecond == 'Mapped (source)'",
                      shiny::tabsetPanel(
                        id = "mappedConceptDifference",
                        shiny::tabPanel(
                          title = "Present in left",
                          tags$br(),
                          DT::dataTableOutput(outputId = "mappedConceptsPresentInLeft")
                        ),
                        shiny::tabPanel(
                          title = "Present in Right",
                          tags$br(),
                          DT::dataTableOutput(outputId = "mappedConceptsPresentInRight")
                        ),
                        shiny::tabPanel(
                          title = "Present in Both",
                          tags$br(),
                          DT::dataTableOutput(outputId = "mappedConceptsPresentInBoth")
                        ),
                        shiny::tabPanel(
                          title = "Present in Either",
                          tags$br(),
                          DT::dataTableOutput(outputId = "mappedConceptsPresentInEither")
                        )
                      )
                    )),
      shiny::column(width = 12,
                    shiny::conditionalPanel(
                      condition = "output.cohortDefinitionCountOfSelectedRows == 2 &
                                   input.conceptSetsType == 'Orphan concepts' &
                                   input.conceptSetsTypeSecond == 'Orphan concepts'",
                      shiny::tabsetPanel(
                        id = "orphanConceptsDifference",
                        shiny::tabPanel(
                          title = "Present in left",
                          tags$br(),
                          DT::dataTableOutput(outputId = "orphanConceptsPresentInLeft")
                        ),
                        shiny::tabPanel(
                          title = "Present in right",
                          tags$br(),
                          DT::dataTableOutput(outputId = "orphanConceptsPresentInRight")
                        ),
                        shiny::tabPanel(
                          title = "Present in both",
                          tags$br(),
                          DT::dataTableOutput(outputId = "orphanConceptsPresentInBoth")
                        ),
                        shiny::tabPanel(
                          title = "Present in either",
                          tags$br(),
                          DT::dataTableOutput(outputId = "orphanConceptsPresentInEither")
                        )
                      )
                    ))
    )
  ),
  shinydashboard::tabItem(
    tabName = "cohortCounts",
    cohortReference("cohortCountsSelectedCohorts"),
    shiny::conditionalPanel(
      condition = "output.cohortCountTableContainsData == true",
      shiny::radioButtons(
        inputId = "cohortCountsTableColumnFilter",
        label = "Display",
        choices = c("Both", "Subjects Only", "Records Only"), 
        selected = "Both",
        inline = TRUE
      ),
      tags$table(width = "100%", 
                 tags$tr(
                   tags$td(align = "right",
                           shiny::downloadButton(
                             "saveCohortCountsTable",
                             label = "",
                             icon = shiny::icon("download"),
                             style = "margin-top: 5px; margin-bottom: 5px;"
                           )
                   )
                 )
      )
    ),
    DT::dataTableOutput("cohortCountsTable"),
    tags$br(),
    shinydashboard::box(
      title = "Notes",
      status = "primary",
      width = NULL,
      solidHeader = TRUE,
      collapsible = TRUE,
      collapsed = TRUE,
      shiny::uiOutput(outputId = "cohortCountsCategories")
    ),
    shiny::conditionalPanel(
      condition = "output.cohortCountRowIsSelected == true",
      DT::dataTableOutput("InclusionRuleStatForCohortSeletedTable")
    )
  ),
  shinydashboard::tabItem(
    tabName = "incidenceRate",
    cohortReference("incidenceRateSelectedCohorts"),
    shinydashboard::box(
      title = "Incidence Rate",
      width = NULL,
      status = "primary",
      tags$table(
        style = "width: 100%",
        tags$tr(
          tags$td(
            valign = "bottom",
            shiny::checkboxGroupInput(
              inputId = "irStratification",
              label = "Stratify by",
              choices = c("Age", "Gender", "Calendar Year"),
              selected = c("Age", "Gender", "Calendar Year"),
              inline = TRUE
            )
          ),
          tags$td(HTML("&nbsp;&nbsp;&nbsp;&nbsp;")),
          tags$td(
            valign = "bottom",
            style = "width:30% !important;margin-top:10px;",
            shiny::conditionalPanel(
              condition = "input.irYscaleFixed",
              shiny::sliderInput(
                inputId = "YscaleMinAndMax",
                label = "Limit y-scale range to:",
                min = c(0),
                max = c(0),
                value = c(0, 0),
                dragRange = TRUE,
                width = 400,
                step = 1,
                sep = "",
              )
            )
          ),
          tags$td(HTML("&nbsp;&nbsp;&nbsp;&nbsp;")),
          tags$td(
            valign = "bottom",
            style = "text-align: right",
            shiny::checkboxInput("irYscaleFixed", "Use same y-scale across databases")
          )
        )
      ),
      tags$table(
        tags$tr(
          style = "width: 100%",
          tags$td(
            shiny::conditionalPanel(
              condition = "input.irStratification.indexOf('Age') > -1",
              shinyWidgets::pickerInput(
                inputId = "incidenceRateAgeFilter",
                label = "Filter By Age",
                width = 300,
                choices = c("All"),
                selected = c("All"),
                multiple = TRUE,
                choicesOpt = list(style = rep_len("color: black;", 999)),
                options = shinyWidgets::pickerOptions(
                  actionsBox = TRUE,
                  liveSearch = TRUE,
                  size = 10,
                  dropupAuto = TRUE,
                  liveSearchStyle = "contains",
                  liveSearchPlaceholder = "Type here to search",
                  virtualScroll = 50
                )
              )
            )
          ),
          tags$td(
            shiny::conditionalPanel(
              condition = "input.irStratification.indexOf('Gender') > -1",
              shinyWidgets::pickerInput(
                inputId = "incidenceRateGenderFilter",
                label = "Filter By Gender",
                width = 300,
                choices = c("All"),
                selected = c("All"),
                multiple = TRUE,
                choicesOpt = list(style = rep_len("color: black;", 999)),
                options = shinyWidgets::pickerOptions(
                  actionsBox = TRUE,
                  liveSearch = TRUE,
                  size = 10,
                  dropupAuto = TRUE,
                  liveSearchStyle = "contains",
                  liveSearchPlaceholder = "Type here to search",
                  virtualScroll = 50
                )
              )
            )
          ),
          tags$td(
            style = "width: 30%",
            shiny::conditionalPanel(
              condition = "input.irStratification.indexOf('Calendar Year') > -1",
              shiny::sliderInput(
                inputId = "incidenceRateCalendarFilter",
                label = "Filter By Calendar Year",
                min = c(0),
                max = c(0),
                value = c(0, 0),
                dragRange = TRUE,
                pre = "Year ",
                step = 1,
                sep = ""
              )
            )
          ),
          tags$td(
            shiny::numericInput(
              inputId = "minPersonYear",
              label = "Minimum person years",
              value = 1000,
              min = 0
            )
          ),
          tags$td(
            shiny::numericInput(
              inputId = "minSubjetCount",
              label = "Minimum subject count",
              value = NULL
            )
          ),
          tags$td(tags$table(width = "100%",
                             tags$tr(
                               tags$td(
                                 align = "right",
                                 shiny::downloadButton(
                                   "saveIncidenceRatePlot",
                                   label = "",
                                   icon = shiny::icon("download"),
                                   style = "margin-top: 5px; margin-bottom: 5px;"
                                 )
                               )
                             )),)
        )
      ),
      shiny::htmlOutput(outputId = "hoverInfoIr"),
      ggiraph::ggiraphOutput(
        outputId = "incidenceRatePlot",
        width = "100%",
        height = "100%"
      )
    )
  ),
  shinydashboard::tabItem(
    tabName = "timeSeries",
    cohortReference("timeSeriesSelectedCohorts"),
    tags$table(
      tags$tr(
        tags$td(
          shiny::radioButtons(
            inputId = "timeSeriesFilter",
            label = "Aggregation period:",
            choices = c("Monthly", "Quaterly","Yearly"),
            selected = "Monthly",
            inline = TRUE
          )
        ),
        tags$td(
          shinyWidgets::pickerInput(
            inputId = "timeSeriesTypeFilter",
            label = "Time series Type",
            choices = c(""),
            width = 200,
            choicesOpt = list(style = rep_len("color: black;", 999)),
            options = shinyWidgets::pickerOptions(
              actionsBox = TRUE,
              liveSearch = TRUE,
              liveSearchStyle = "contains",
              size = 10,
              liveSearchPlaceholder = "Type here to search",
              virtualScroll = 50
            )
          )
        )
      )
    ),
    shinydashboard::box(
      title = "Time Series",
      width = NULL,
      status = "primary",
      solidHeader = TRUE,
      
      shiny::radioButtons(
        inputId = "timeSeriesType",
        label = "",
        choices = c("Table", "Plot"),
        selected = "Table",
        inline = TRUE
      ),
      shiny::conditionalPanel(
        condition = "input.timeSeriesType=='Table'",
        tags$table(width = "100%",
                   tags$tr(
                     tags$td(
                       align = "right",
                       shiny::downloadButton(
                         "saveTimeSeriesTable",
                         label = "",
                         icon = shiny::icon("download"),
                         style = "margin-top: 5px; margin-bottom: 5px;"
                       )
                     )
                   )),
        DT::dataTableOutput("timeSeriesTable")
      ),
      shiny::conditionalPanel(
        condition = "input.timeSeriesType=='Plot'",
        ggiraph::ggiraphOutput("timeSeriesPlot", width = "100%", height = "100%")
      )
    )
  ),
  shinydashboard::tabItem(
    tabName = "timeDistribution",
    cohortReference("timeDistSelectedCohorts"),
    shiny::radioButtons(
      inputId = "timeDistributionType",
      label = "",
      choices = c("Table", "Plot"),
      selected = "Plot",
      inline = TRUE
    ),
    shiny::conditionalPanel(condition = "input.timeDistributionType=='Table'",
                            tags$table(width = "100%", 
                                       tags$tr(
                                         tags$td(align = "right",
                                                 shiny::downloadButton(
                                                   "saveTimeDistTable",
                                                   label = "",
                                                   icon = shiny::icon("download"),
                                                   style = "margin-top: 5px; margin-bottom: 5px;"
                                                 )
                                         )
                                       )
                            ),
                            DT::dataTableOutput("timeDistTable")),
    shiny::conditionalPanel(
      condition = "input.timeDistributionType=='Plot'",
      shinydashboard::box(
        title = "Time Distributions",
        width = NULL,
        status = "primary",
        tags$br(),
        ggiraph::ggiraphOutput("timeDisPlot", width = "100%", height = "100%")
      )
    )
  ),
  shinydashboard::tabItem(
    tabName = "includedConcepts",
    cohortReference("includedConceptsSelectedCohort"),
    shinydashboard::box(
      title = "Concepts in Data Source",
      width = NULL,
      column(
        4,
        shiny::radioButtons(
          inputId = "includedType",
          label = "",
          choices = c("Source fields", "Standard fields"),
          selected = "Standard fields",
          inline = TRUE
        )
      ),
      shiny::conditionalPanel(
        condition = "output.includeConceptsTableContainsData == true",
        column(
          4,
          shiny::radioButtons(
            inputId = "includedConceptsTableColumnFilter",
            label = "",
            choices = c("Both", "Subjects only", "Records only"), # 
            selected = "Subjects only",
            inline = TRUE
          )
        ),
        column(4,
               tags$table(width = "100%",
                          tags$tr(
                            tags$td(
                              align = "right",
                              shiny::downloadButton(
                                "saveIncludedConceptsTable",
                                label = "",
                                icon = shiny::icon("download"),
                                style = "margin-top: 5px; margin-bottom: 5px;"
                              )
                            )
                          )))
      ),
      
      DT::dataTableOutput("includedConceptsTable")
    )
  ),
  shinydashboard::tabItem(
    tabName = "orphanConcepts",
    cohortReference("orphanConceptsSelectedCohort"),
    tags$table(width = "100%",
               tags$tr(
                 tags$td(
                   shiny::radioButtons(
                     inputId = "orphanConceptsType",
                     label = "Filters",
                     choices = c("All", "Standard Only", "Non Standard Only"),
                     selected = "All",
                     inline = TRUE
                   )
                 ),
                 tags$td(HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")),
                 tags$td(
                   shiny::conditionalPanel(
                     condition = "output.orphanconceptContainData == true",
                     tags$table(width = "100%",
                                tags$tr(
                                  tags$td(
                                    shiny::radioButtons(
                                      inputId = "orphanConceptsColumFilterType",
                                      label = "Display",
                                      choices = c("All", "Subjects only","Records only"),
                                      selected = "All",
                                      inline = TRUE
                                    )
                                  ),
                                  tags$td(align = "right",
                                          shiny::downloadButton(
                                            "saveOrphanConceptsTable",
                                            label = "",
                                            icon = shiny::icon("download"),
                                            style = "margin-top: 5px; margin-bottom: 5px;"
                                          )
                                  )
                                )
                     )
                   )
                 )
               )
    ),
    DT::dataTableOutput(outputId = "orphanConceptsTable")
  ),
  # shinydashboard::tabItem(
  #   tabName = "inclusionRuleStats",
  #   cohortReference("inclusionRuleStatSelectedCohort"),
  #   shiny::conditionalPanel(
  #     condition = "output.inclusionRuleStatsContainsData == true",
  #     column(6,
  #            shiny::radioButtons(
  #              inputId = "inclusionRuleTableFilters",
  #              label = "Inclusion Rule Events",
  #              choices = c("All", "Meet", "Gain", "Remain", "Totals"),
  #              selected = "All",
  #              inline = TRUE
  #            )
  #     ),
  #     column(6,
  #            tags$table(width = "100%",
  #                       tags$tr(
  #                         tags$td(
  #                           align = "right",
  #                           shiny::downloadButton(
  #                             "saveInclusionRuleTable",
  #                             label = "",
  #                             icon = shiny::icon("download"),
  #                             style = "margin-top: 5px; margin-bottom: 5px;"
  #                           )
  #                         )
  #                       )))
  #   ),
  #   DT::dataTableOutput(outputId = "inclusionRuleTable")
  # ),
  shinydashboard::tabItem(
    tabName = "indexEventBreakdown",
    cohortReference("indexEventBreakdownSelectedCohort"),
    tags$table(width = '100%',
      tags$tr(
        tags$td(
          shiny::radioButtons(
            inputId = "indexEventBreakdownTableRadioButton",
            label = "",
            choices = c("All", "Standard concepts", "Non Standard Concepts"),
            selected = "All",
            inline = TRUE
          )
        ),
        tags$td(HTML("&nbsp;&nbsp;&nbsp;")),
        tags$td(
          shiny::radioButtons(
            inputId = "indexEventBreakdownTableFilter",
            label = "Display",
            choices = c("Both", "Records", "Persons"), 
            selected = "Persons",
            inline = TRUE
          )
        ),
        tags$td(HTML("&nbsp;&nbsp;&nbsp;")),
        tags$td(
          shiny::radioButtons(
            inputId = "indexEventBreakdownValueFilter",
            label = "Display Value Type",
            choices = c("Absolute", "Percentage"), 
            selected = "Absolute",
            inline = TRUE
          )
        ),
       tags$td(
         shinyWidgets::pickerInput(
           inputId = "breakdownDomainTable",
           label = "Domain Table",
           choices = c(""),
           multiple = TRUE,
           width = 200,
           choicesOpt = list(style = rep_len("color: black;", 999)),
           options = shinyWidgets::pickerOptions(
             actionsBox = TRUE,
             liveSearch = TRUE,
             liveSearchStyle = "contains",
             size = 10,
             liveSearchPlaceholder = "Type here to search",
             virtualScroll = 50
           )
         )
       ),
       tags$td(
         shinyWidgets::pickerInput(
           inputId = "breakdownDomainField",
           label = "Domain Field",
           choices = c(""),
           multiple = TRUE,
           width = 200,
           choicesOpt = list(style = rep_len("color: black;", 999)),
           options = shinyWidgets::pickerOptions(
             actionsBox = TRUE,
             liveSearch = TRUE,
             liveSearchStyle = "contains",
             size = 10,
             liveSearchPlaceholder = "Type here to search",
             virtualScroll = 50
           )
         )
       )
      )
    ),
    tags$table(width = "100%", 
               tags$tr(
                 tags$td(align = "right",
                         shiny::downloadButton(
                           "saveBreakdownTable",
                           label = "",
                           icon = shiny::icon("download"),
                           style = "margin-top: 5px; margin-bottom: 5px;"
                         )
                 )
               )
    ),
    DT::dataTableOutput(outputId = "breakdownTable")
  ),
  shinydashboard::tabItem(
    tabName = "visitContext",
    cohortReference("visitContextSelectedCohort"),
    shiny::conditionalPanel(
      condition = "output.visitContextContainData == true",
      tags$table(width = '100%',
        tags$tr(
          tags$td(
            shiny::radioButtons(
              inputId = "visitContextTableFilters",
              label = "Display",
              choices = c("All", "Before", "During", "Simultaneous", "After"),
              selected = "All",
              inline = TRUE
            )
          ),
          tags$td(
            shiny::radioButtons(
              inputId = "visitContextPersonOrRecords",
              label = "Display",
              choices = c("Person", "Record"),
              selected = "Person",
              inline = TRUE
            )
          ),
          tags$td(
            align = "right",
            shiny::downloadButton(
              "saveVisitContextTable",
              label = "",
              icon = shiny::icon("download"),
              style = "margin-top: 5px; margin-bottom: 5px;"
            )
          )
        )
      )
    ),
    DT::dataTableOutput(outputId = "visitContextTable")
  ),
  shinydashboard::tabItem(
    tabName = "cohortOverlap",
    cohortReference("cohortOverlapSelectedCohort"),
    shinydashboard::box(
      title = "Cohort Overlap (Subjects)",
      width = NULL,
      status = "primary",
      tags$table(width = "100%", 
                 tags$tr(
                   tags$td(
                     shiny::radioButtons(
                       inputId = "overlapPlotType",
                       label = "",
                       choices = c("Percentages", "Counts"),
                       selected = "Percentages",
                       inline = TRUE
                     )
                   ),
                   tags$td(align = "right",
                           shiny::downloadButton(
                             "saveCohortOverlapTable",
                             label = "",
                             icon = shiny::icon("download"),
                             style = "margin-top: 5px; margin-bottom: 5px;"
                           )
                   )
                 )
      ),
      ggiraph::ggiraphOutput("overlapPlot", width = "100%", height = "100%")
    )
  ),
  shinydashboard::tabItem(
    tabName = "cohortCharacterization",
    cohortReference("characterizationSelectedCohort"),
    tags$table(
      tags$tr(
        tags$td(
          shiny::radioButtons(
            inputId = "charType",
            label = "",
            choices = c("Pretty", "Raw"),
            selected = "Pretty",
            inline = TRUE
          )
        ),
        tags$td(
          shiny::conditionalPanel(condition = "input.charType == 'Raw'",
                                  tags$table(tags$tr(
                                    tags$td(
                                      shinyWidgets::pickerInput(
                                        inputId = "characterizationAnalysisNameFilter",
                                        label = "Analysis name",
                                        choices = c(""),
                                        selected = c(""),
                                        inline = TRUE,
                                        multiple = TRUE,
                                        width = 300,
                                        choicesOpt = list(style = rep_len("color: black;", 999)),
                                        options = shinyWidgets::pickerOptions(
                                          actionsBox = TRUE,
                                          liveSearch = TRUE,
                                          size = 10,
                                          liveSearchStyle = "contains",
                                          liveSearchPlaceholder = "Type here to search",
                                          virtualScroll = 50
                                        )
                                      )
                                    ),
                                    tags$td(
                                      shinyWidgets::pickerInput(
                                        inputId = "characterizationDomainNameFilter",
                                        label = "Domain name",
                                        choices = c(""),
                                        selected = c(""),
                                        inline = TRUE,
                                        multiple = TRUE,
                                        width = 300,
                                        choicesOpt = list(style = rep_len("color: black;", 999)),
                                        options = shinyWidgets::pickerOptions(
                                          actionsBox = TRUE,
                                          liveSearch = TRUE,
                                          size = 10,
                                          liveSearchStyle = "contains",
                                          liveSearchPlaceholder = "Type here to search",
                                          virtualScroll = 50
                                        )
                                      )
                                    ),
                                    tags$td(
                                      shiny::radioButtons(
                                        inputId = "charProportionOrContinuous",
                                        label = "",
                                        choices = c("All", "Proportion", "Continuous"),
                                        selected = "Proportion",
                                        inline = TRUE
                                      )
                                    )
                                  )))
        )
      ),
      tags$tr(
        tags$td(colspan = 2,
                shiny::conditionalPanel(
                  condition = "input.charType == 'Raw'",
                  shiny::radioButtons(
                    inputId = "characterizationColumnFilters",
                    label = "Display",
                    choices = c("Mean and Standard Deviation", "Mean only"),
                    selected = "Mean only",
                    inline = TRUE
                  )
                )
        )
      )),
    tags$table(width = "100%", 
               tags$tr(
                 tags$td(align = "right",
                         shiny::downloadButton(
                           outputId = "saveCohortCharacterizationTable",
                           label = "",
                           icon = shiny::icon("download"),
                           style = "margin-top: 5px; margin-bottom: 5px;"
                         )
                 )
               )
    ),
    DT::dataTableOutput(outputId = "characterizationTable")
  ),
  shinydashboard::tabItem(
    tabName = "temporalCharacterization",
    cohortReferenceWithDatabaseId("temporalCharacterizationSelectedCohort", "temporalCharacterizationSelectedDatabase"),
    tags$table(tags$tr(
      tags$td(
        shinyWidgets::pickerInput(
          inputId = "temporalAnalysisNameFilter",
          label = "Analysis name",
          choices = c(""),
          selected = c(""),
          multiple = TRUE,
          choicesOpt = list(style = rep_len("color: black;", 999)),
          options = shinyWidgets::pickerOptions(
            actionsBox = TRUE,
            liveSearch = TRUE,
            size = 10,
            liveSearchStyle = "contains",
            liveSearchPlaceholder = "Type here to search",
            virtualScroll = 50
          )
        )
      ),
      tags$td(
        shinyWidgets::pickerInput(
          inputId = "temporalDomainNameFilter",
          label = "Domain name",
          choices = c(""),
          selected = c(""),
          multiple = TRUE,
          choicesOpt = list(style = rep_len("color: black;", 999)),
          options = shinyWidgets::pickerOptions(
            actionsBox = TRUE,
            liveSearch = TRUE,
            size = 10,
            liveSearchStyle = "contains",
            liveSearchPlaceholder = "Type here to search",
            virtualScroll = 50
          )
        )
      ),
      tags$td(
        shiny::radioButtons(
          inputId = "temporalProportionOrContinuous",
          label = "",
          choices = c("All", "Proportion", "Continuous"),
          selected = "Proportion",
          inline = TRUE
        )
      )
    )),
    tags$table(width = "100%", 
               tags$tr(
                 tags$td(align = "right",
                         shiny::downloadButton(
                           outputId = "saveTemporalCharacterizationTable",
                           label = "",
                           icon = shiny::icon("download"),
                           style = "margin-top: 5px; margin-bottom: 5px;"
                         )
                 )
               )
    ),
    DT::dataTableOutput("temporalCharacterizationTable")
  ),
  shinydashboard::tabItem(
    tabName = "compareCohortCharacterization",
    cohortReferenceWithDatabaseId("cohortCharCompareSelectedCohort", "cohortCharCompareSelectedDatabase"),
    tags$table(
      tags$tr(
        tags$td(
          shiny::radioButtons(
            inputId = "charCompareType",
            label = "",
            choices = c("Pretty table", "Raw table", "Plot"),
            selected = "Plot",
            inline = TRUE
          ),
        ),
        tags$td(HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")),
        tags$td(
          shiny::conditionalPanel(
            condition = "input.charCompareType == 'Plot'",
            shiny::sliderInput(
              inputId = "compareCohortXMeanFilter",
              label = "Filter X-axis",
              min = c(0.0),
              max = c(1.0),
              value = c(0.0, 1.0),
              dragRange = TRUE,
              pre = "Mean ",
              step = 0.1,
              sep = ""
            )
          )
        ),
        tags$td(HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")),
        tags$td(
          shiny::conditionalPanel(
            condition = "input.charCompareType == 'Plot'",
            shiny::sliderInput(
              inputId = "compareCohortYMeanFilter",
              label = "Filter Y-axis",
              min = c(0.0),
              max = c(1.0),
              value = c(0.0, 1.0),
              dragRange = TRUE,
              pre = "Mean ",
              step = 0.1,
              sep = ""
            )
          )
        ),
        tags$td(
          shiny::conditionalPanel(
            condition = "input.charCompareType == 'Raw table'",
            shiny::radioButtons(
              inputId = "compareCharacterizationColumnFilters",
              label = "Display",
              choices = c("Mean and Standard Deviation", "Mean only"),
              selected = "Mean only",
              inline = TRUE
            )
          )
        )
      )
    ),
    
    shiny::conditionalPanel(condition = "input.charCompareType == 'Raw table' | input.charCompareType=='Plot'",
                            tags$table(tags$tr(
                              tags$td(
                                shinyWidgets::pickerInput(
                                  inputId = "charCompareAnalysisNameFilter",
                                  label = "Analysis name",
                                  choices = c(""),
                                  selected = c(""),
                                  multiple = TRUE,
                                  width = 200,
                                  choicesOpt = list(style = rep_len("color: black;", 999)),
                                  options = shinyWidgets::pickerOptions(
                                    actionsBox = TRUE,
                                    liveSearch = TRUE,
                                    size = 10,
                                    liveSearchStyle = "contains",
                                    liveSearchPlaceholder = "Type here to search",
                                    virtualScroll = 50
                                  )
                                )
                              ),
                              tags$td(
                                shinyWidgets::pickerInput(
                                  inputId = "charaCompareDomainNameFilter",
                                  label = "Domain name",
                                  choices = c(""),
                                  selected = c(""),
                                  multiple = TRUE,
                                  width = 200,
                                  choicesOpt = list(style = rep_len("color: black;", 999)),
                                  options = shinyWidgets::pickerOptions(
                                    actionsBox = TRUE,
                                    liveSearch = TRUE,
                                    size = 10,
                                    liveSearchStyle = "contains",
                                    liveSearchPlaceholder = "Type here to search",
                                    virtualScroll = 50
                                  )
                                )
                              ),
                              tags$td(
                                shiny::radioButtons(
                                  inputId = "charCompareProportionOrContinuous",
                                  label = "",
                                  choices = c("All", "Proportion", "Continuous"),
                                  selected = "Proportion",
                                  inline = TRUE
                                )
                              )
                            ))),
    shiny::conditionalPanel(condition = "input.charCompareType=='Pretty table' | input.charCompareType=='Raw table'",
                            tags$table(width = "100%", 
                                       tags$tr(
                                         tags$td(align = "right",
                                                 shiny::downloadButton(
                                                   outputId = "saveCompareCohortCharacterizationTable",
                                                   label = "",
                                                   icon = shiny::icon("download"),
                                                   style = "margin-top: 5px; margin-bottom: 5px;"
                                                 )
                                         )
                                       )
                            ),
                            DT::dataTableOutput("charCompareTable")),
    shiny::conditionalPanel(
      condition = "input.charCompareType=='Plot'",
      shinydashboard::box(
        title = "Compare Cohort Characterization",
        width = NULL,
        status = "primary",
        shiny::htmlOutput("compareCohortCharacterizationSelectedCohort"),
        ggiraph::ggiraphOutput(
          outputId = "charComparePlot",
          width = "100%",
          height = "100%"
        )
      )
    )
  ),
  shinydashboard::tabItem(
    tabName = "compareTemporalCharacterization",
    cohortReferenceWithDatabaseId(cohortOutputId = "temporalCharCompareSelectedCohort", databaseOutputId = "temporalCharCompareSelectedDatabase"),
    tags$table(
      tags$tr(
        tags$td(
          shiny::radioButtons(
            inputId = "temporalCharacterizationType",
            label = "",
            choices = c("Raw table", "Plot"),
            #"Pretty table", removed pretty option for compare temporal characterization
            # Pretty table can be put back in - we will need a different Table1Specs for temporal characterization
            selected = "Plot",
            inline = TRUE
          )
        ),
        tags$td(
          shiny::conditionalPanel(
            condition = "input.temporalCharacterizationType == 'Plot'",
            shiny::sliderInput(
              inputId = "temporalCharacterizationXMeanFilter",
              label = "Filter X-axis",
              min = c(0.0),
              max = c(1.0),
              value = c(0.0, 1.0),
              dragRange = TRUE,
              pre = "Mean ",
              step = 0.1,
              sep = ""
            )
          )
        ),
        tags$td(HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")),
        tags$td(
          shiny::conditionalPanel(
            condition = "input.temporalCharacterizationType == 'Plot'",
            shiny::sliderInput(
              inputId = "temporalCharacterizationYMeanFilter",
              label = "Filter Y-axis",
              min = c(0.0),
              max = c(1.0),
              value = c(0.0, 1.0),
              dragRange = TRUE,
              pre = "Mean ",
              step = 0.1,
              sep = ""
            )
          )
        ),
        tags$td(HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")),
        tags$td(
          shiny::conditionalPanel(
            condition = "input.temporalCharacterizationType == 'Raw table'",
            shiny::radioButtons(
              inputId = "temporalCharacterizationTypeColumnFilter",
              label = "Show  in table:",
              choices = c("Mean and Standard Deviation", "Mean only"),
              selected = "Mean only",
              inline = TRUE
            )
          )
        )
      )
    ),
    shiny::conditionalPanel(condition = "input.temporalCharacterizationType == 'Raw table' | input.temporalCharacterizationType=='Plot'",
                            tags$table(tags$tr(
                              tags$td(
                                shinyWidgets::pickerInput(
                                  inputId = "temporalCompareAnalysisNameFilter",
                                  label = "Analysis name",
                                  choices = c(""),
                                  selected = c(""),
                                  multiple = TRUE,
                                  choicesOpt = list(style = rep_len("color: black;", 999)),
                                  options = shinyWidgets::pickerOptions(
                                    actionsBox = TRUE,
                                    liveSearch = TRUE,
                                    size = 10,
                                    liveSearchStyle = "contains",
                                    liveSearchPlaceholder = "Type here to search",
                                    virtualScroll = 50
                                  )
                                )
                              ),
                              tags$td(
                                shinyWidgets::pickerInput(
                                  inputId = "temporalCompareDomainNameFilter",
                                  label = "Domain name",
                                  choices = c(""),
                                  selected = c(""),
                                  multiple = TRUE,
                                  choicesOpt = list(style = rep_len("color: black;", 999)),
                                  options = shinyWidgets::pickerOptions(
                                    actionsBox = TRUE,
                                    liveSearch = TRUE,
                                    size = 10,
                                    liveSearchStyle = "contains",
                                    liveSearchPlaceholder = "Type here to search",
                                    virtualScroll = 50
                                  )
                                )
                              ),
                              tags$td(
                                shiny::radioButtons(
                                  inputId = "temporalCharacterProportionOrContinuous",
                                  label = "Filter to:",
                                  choices = c("All", "Proportion", "Continuous"),
                                  selected = "Proportion",
                                  inline = TRUE
                                )
                              )
                            ))),
    shiny::conditionalPanel(
      condition = "input.temporalCharacterizationType=='Pretty table' |
                            input.temporalCharacterizationType=='Raw table'",
      tags$table(width = "100%", 
                 tags$tr(
                   tags$td(align = "right",
                           shiny::downloadButton(
                             outputId = "saveCompareTemporalCharacterizationTable",
                             label = "",
                             icon = shiny::icon("download"),
                             style = "margin-top: 5px; margin-bottom: 5px;"
                           )
                   )
                 )
      ),
      DT::dataTableOutput(outputId = "temporalCharacterizationCompareTable")
    ),
    shiny::conditionalPanel(
      condition = "input.temporalCharacterizationType=='Plot'",
      shinydashboard::box(
        title = "Compare Temporal Characterization",
        width = NULL,
        status = "primary",
        ggiraph::ggiraphOutput(
          outputId = "temporalCharComparePlot",
          width = "100%",
          height = "100%"
        )
      )
    )
  ),
  shinydashboard::tabItem(tabName = "databaseInformation",
                          DT::dataTableOutput("databaseInformationTable"))
)


#body
body <- shinydashboard::dashboardBody(bodyTabItems,
                                      htmltools::withTags(
                                        div(style = "margin-left : 0px",
                                            h6(appInformationText)
                                        )))


#main
shinydashboard::dashboardPage(
  tags$head(tags$style(HTML(
    "
      th, td {
        padding-right: 10px;
      }

    "
  ))),
  header = header,
  sidebar = sidebar,
  body = body
)
