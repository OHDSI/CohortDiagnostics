<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running Cohort Diagnostics • CohortDiagnostics</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running Cohort Diagnostics">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CohortDiagnostics</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.3.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/CreatingAStudyPackage.html">Creating a study package</a></li>
    <li><a class="dropdown-item" href="../articles/DatabaseModeInDiagnosticsExplorer.html">Database mode in Diagnostics Explorer</a></li>
    <li><a class="dropdown-item" href="../articles/RunningCohortDiagnostics.html">Running Cohort Diagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/ViewingResultsUsingDiagnosticsExplorer.html">Viewing results using Diagnostics Explorer</a></li>
    <li><a class="dropdown-item" href="../articles/WhatIsCohortDiagnostics.html">What is Cohort Diagnostics?</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://ohdsi.github.io/Hades"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/CohortDiagnostics/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Running Cohort Diagnostics</h1>
                        <h4 data-toc-skip class="author">Gowtham Rao and
James P. Gilbert</h4>
            
            <h4 data-toc-skip class="date">2025-01-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/CohortDiagnostics/blob/HEAD/vignettes/RunningCohortDiagnostics.Rmd" class="external-link"><code>vignettes/RunningCohortDiagnostics.Rmd</code></a></small>
      <div class="d-none name"><code>RunningCohortDiagnostics.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette discusses the process of generating a results set with
<code>CohortDiagnostics</code> starting with cohort generation. Please
see the <a href="https://ohdsi.github.io/hades" class="external-link">HADES library</a> for
more information on the background for this.</p>
<div class="section level3">
<h3 id="pre-requisites">pre-requisites<a class="anchor" aria-label="anchor" href="#pre-requisites"></a>
</h3>
<p>Ensure that <code>CohortDiagnostics</code> is installed on your
system and updated to the latest version. For this example we will also
be using the <code>Eunomia</code> test package. Optionally, you may
install the <code>ROhdsiWebApi</code> package to download cohort
definitions from an ATLAS instance:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"OHDSI/Eunomia"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"OHDSI/ROhdsiWebApi"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="configuring-the-connection-to-the-server">Configuring the connection to the server<a class="anchor" aria-label="anchor" href="#configuring-the-connection-to-the-server"></a>
</h2>
<p>We need to tell R how to connect to the server where the data are.
<code>CohortDiagnostics</code> uses the <code>DatabaseConnector</code>
package, which provides the <code>createConnectionDetails</code>
function. Type <code><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">?createConnectionDetails</a></code> for the specific
settings required for the various database management systems (DBMS).
For example, one might connect to a PostgreSQL database using this
code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/CohortDiagnostics">CohortDiagnostics</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">createConnectionDetails</a></span><span class="op">(</span></span>
<span>  dbms <span class="op">=</span> <span class="st">"postgresql"</span>,</span>
<span>  server <span class="op">=</span> <span class="st">"localhost/ohdsi"</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"joe"</span>,</span>
<span>  password <span class="op">=</span> <span class="st">"supersecret"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For the purposes of this example, we will use the Eunomia test CDM
package that is in an Sqlite database stored locally.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html" class="external-link">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdmDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">"main"</span></span>
<span><span class="va">tempEmulationSchema</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">cohortDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">"main"</span></span>
<span><span class="va">cohortTable</span> <span class="op">&lt;-</span> <span class="st">"cohort"</span></span></code></pre></div>
<p>The last four lines define the <code>cdmDatabaseSchema</code>,
<code>tempEmulationSchema</code>, <code>cohortDatabaseSchema</code>, and
<code>cohortTable</code> variables. We’ll use the
<code>cdmDatabaseSchema</code> later to tell R where the data in CDM
format live. The <code>tempEmulationSchema</code> is needed only for
Oracle users, since Oracle does not support temporary tables. The
<code>cohortDatabaseSchema</code>, and <code>cohortTable</code> specify
where we want to instantiate our cohorts. Note that for Microsoft SQL
Server, database schemas need to specify both the database and the
schema, so for example
<code>cdmDatabaseSchema &lt;- "my_cdm_data.dbo"</code>.</p>
</div>
<div class="section level2">
<h2 id="running-cohort-diagnostics">Running cohort diagnostics<a class="anchor" aria-label="anchor" href="#running-cohort-diagnostics"></a>
</h2>
<div class="section level3">
<h3 id="loading-cohort-references-from-a-package">Loading cohort references from a package<a class="anchor" aria-label="anchor" href="#loading-cohort-references-from-a-package"></a>
</h3>
<p>The prefered usage of cohort diagnostics is through the use of a
study package. This is a dedicated R package that can be installed on a
system and run. The primary reason for this is due to reproducibility,
cohort definitions and resources frequently change. However, a study
package can be seen as a snapshot, frozen at the time of creation and
incrementally updated.</p>
<p>For example, the cohort diagnostics package includes an example set
of cohort sql and json to run on the <code>Eunomia</code> test data in
the OMOP Common Data Model format.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/CohortDiagnostics">CohortDiagnostics</a></span><span class="op">)</span></span>
<span><span class="va">cohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/getCohortDefinitionSet.html" class="external-link">getCohortDefinitionSet</a></span><span class="op">(</span></span>
<span>  settingsFileName <span class="op">=</span> <span class="st">"Cohorts.csv"</span>,</span>
<span>  jsonFolder <span class="op">=</span> <span class="st">"cohorts"</span>,</span>
<span>  sqlFolder <span class="op">=</span> <span class="st">"sql/sql_server"</span>,</span>
<span>  packageName <span class="op">=</span> <span class="st">"CohortDiagnostics"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Looking at this data.frame of Cohorts you will see the sql and json
for these cohorts:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/View.html" class="external-link">View</a></span><span class="op">(</span><span class="va">cohortDefinitionSet</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="loading-cohort-references-from-webapi">Loading cohort references from WebApi<a class="anchor" aria-label="anchor" href="#loading-cohort-references-from-webapi"></a>
</h3>
<p>It is often desirable to perform cohort diagnostics on definitions
stored in an ATLAS instance. Though this is not the preferred way of
running studies (and this is certainly not the preferred method for an
OHDSI network study involving multiple sites) it is possible to load
references into a data frame used by cohort diagnostics.</p>
<p>The following code demonstrates how to create a set of cohort
references from ATLAS that can be used by cohort diagnostics:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up url</span></span>
<span><span class="va">baseUrl</span> <span class="op">&lt;-</span> <span class="st">"https://atlas.hosting.com/WebAPI"</span></span>
<span><span class="co"># list of cohort ids</span></span>
<span><span class="va">cohortIds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">18345</span>, <span class="fl">18346</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu">ROhdsiWebApi</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ROhdsiWebApi/reference/exportCohortDefinitionSet.html" class="external-link">exportCohortDefinitionSet</a></span><span class="op">(</span></span>
<span>  baseUrl <span class="op">=</span> <span class="va">baseUrl</span>,</span>
<span>  cohortIds <span class="op">=</span> <span class="va">cohortIds</span>,</span>
<span>  generateStats <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Consult the ROhdsiWebApi documentation for details on authentication
to your atlas instance. Please note that in order to generate inclusion
rules statistics (a useful diagnostic tool) the parameter
<code>generateStats</code> should be set to <code>TRUE</code>.</p>
</div>
<div class="section level3">
<h3 id="generating-cohorts">Generating cohorts<a class="anchor" aria-label="anchor" href="#generating-cohorts"></a>
</h3>
<p>Cohorts must be generated before cohort diagnostics can be run.</p>
<div class="section level4">
<h4 id="using-cohortgenerator-to-instantiate-cohorts">Using CohortGenerator to instantiate cohorts<a class="anchor" aria-label="anchor" href="#using-cohortgenerator-to-instantiate-cohorts"></a>
</h4>
<p>For example,</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortTableNames</span> <span class="op">&lt;-</span> <span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/getCohortTableNames.html" class="external-link">getCohortTableNames</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="va">cohortTable</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Next create the tables on the database</span></span>
<span><span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/createCohortTables.html" class="external-link">createCohortTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate the cohort set</span></span>
<span><span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/generateCohortSet.html" class="external-link">generateCohortSet</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="va">cohortDatabaseSchema</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Note, that the above code will delete an existing
table</strong>. However, incremental mode can be used when setting the
parameter <code>incremental = TRUE</code>.</p>
<p>The resulting cohort table should include the columns:</p>
<p><code>cohort_definition_id</code>, <code>subject_id</code>,
<code>cohort_start_date</code>, <code>cohort_end_date</code></p>
</div>
</div>
<div class="section level3">
<h3 id="executing-cohort-diagnostics">Executing cohort diagnostics<a class="anchor" aria-label="anchor" href="#executing-cohort-diagnostics"></a>
</h3>
<p>Once cohort definitions are loaded and cohort tables have been
populated cohort diagnostics is ready to be executed.</p>
<p>First we set an export folder, this is where the results will be
stored.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exportFolder</span> <span class="op">&lt;-</span> <span class="st">"export"</span></span></code></pre></div>
<p>Then we execute the function (using the default settings) as
follows:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/executeDiagnostics.html">executeDiagnostics</a></span><span class="op">(</span><span class="va">cohortDefinitionSet</span>,</span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortTable <span class="op">=</span> <span class="va">cohortTable</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="va">cohortDatabaseSchema</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>,</span>
<span>  exportFolder <span class="op">=</span> <span class="va">exportFolder</span>,</span>
<span>  databaseId <span class="op">=</span> <span class="st">"MyCdm"</span>,</span>
<span>  minCellCount <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cohort-statistics-table-clean-up">Cohort Statistics Table Clean up<a class="anchor" aria-label="anchor" href="#cohort-statistics-table-clean-up"></a>
</h3>
<p>The above cohort generation process will create a number of residual
tables. As the process is complete, these are no longer required and can
be removed.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/dropCohortStatsTables.html" class="external-link">dropCohortStatsTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="va">cohortDatabaseSchema</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="cohort-diagnostics-output">Cohort Diagnostics Output<a class="anchor" aria-label="anchor" href="#cohort-diagnostics-output"></a>
</h2>
<p>Once the diagnostics have completed, a zip file will have been
created in the specified export folder. This zip file can be shared
between sites, as it does not contain patient-identifiable information.
When unzipped, the zip file will contain several .csv files that maybe
easily audited. Note that cell counts smaller than 5 have been removed,
as specified using the <code>minCellCount</code> argument, to ensure
non-identifiability.</p>
<div class="section level3">
<h3 id="creating-an-sqlite-db-file">Creating an sqlite db file<a class="anchor" aria-label="anchor" href="#creating-an-sqlite-db-file"></a>
</h3>
<p>Assuming you completed the steps described above for one or more
databases, you should now have a set of zip files, one per database.
Make sure to place all zip files in a single folder.</p>
<p>Optionally, we can pre-merge the zip files into an sqlite database so
we can view results in the Shiny app:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/createMergedResultsFile.html">createMergedResultsFile</a></span><span class="op">(</span><span class="va">exportFolder</span><span class="op">)</span></span></code></pre></div>
<p>This file can be used in the shiny app to explore results. See the
vignette “Viewing results using Diagnostics Explorer” for more
details.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jamie Gilbert, Gowtham Rao, Martijn Schuemie, Patrick Ryan, James Weaver.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
