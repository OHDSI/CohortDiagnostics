---
html_document:
  number_sections: yes
author: "Gowtham Rao"
date: "`r Sys.Date()`"
output:
  pdf_document: null
  toc: yes
  html_document:
    df_print: paged
title: "Cohort Interval Algebra"
toc: yes
vignette: "%\\VignetteIndexEntry{CohortIntervalAlgebra} %\\VignetteEncoding{UTF-8}
  \    %\\VignetteEngine{knitr::rmarkdown}\n"
---
  
  ```{r, echo = FALSE, message = FALSE}
library(SqlRender)
knitr::opts_chunk$set(
  cache = FALSE,
  comment = "#>",
  error = FALSE,
  tidy = FALSE)
  ```

# Cohort

A cohort is a set of persons who satisfy one or more inclusion criteria (a phenotype) for a duration of time - and this is identified by cohort start date (start) and cohort end date (end). In OHDSI a) One person may belong to multiple cohorts, b) One person may belong to the same cohort for multiple different time periods, c) One person may not belong to the same cohort multiple times during the same period of time, d) A cohort may have zero or more members.

# Multiple cohorts
Thus a person may belong to different cohorts, and these cohorts may or may not have shared dates. Studying population level temporal relationships between persons start/end of one cohort and start/end of another cohort may offer us useful characterization insights.

## Use Cases
An example is a cohort of persons dispensed drug Hydrochlorthiazide (HCTZ), and a cohort of persons with diagnosis of Hypertension (HTN). Since most agree that HCTZ is one of first line drugs used in the management of Hypertension - we expect that
- persons with the diagnosis of hypertension and the dispensation of HCTZ to be present in both cohorts.
- in general, we expect the start of the HCTZ cohort to be on or after the diagnosis of Hypertension (because we expect the management to start after diagnosis), i.e. hctz.cohort_start_date >= hypertension.cohort_start_date. If we find that a large proportion of persons had HCTZ start prior to HTN diagnosis - then this may indicate index date misclassification.

Another use case maybe to study the relationship between end of a treatment and start of a new condition. e.g. if a person is on a long term treatment with HCTZ, stops the drug (and no other treatment is initiated) - we may expect to observe their hypertension to be uncontrolled after stopping HCTZ. i.e. HCTZ.cohort_end_date < uncontrolledHTN.cohort_start_date


# Formal representation
One formal way of representing temporal relationships between multiple cohort is to use [Allen's interval algebra](https://en.wikipedia.org/wiki/Allen%27s_interval_algebra) (a calculus for temporal reasoning that was introduced by James F. Allen in 1983). 



```{r tidy=FALSE,eval=TRUE, echo = FALSE}
ontology <-
  CohortDiagnostics::getCohortRelationshipIntervalOntology()

lines <- function(analysisId) {
  data <- ontology %>% 
    dplyr::filter(.data$analysisId == !!analysisId)
  
  lines <- c()
  lines[[1]] <- paste0(" **", data$ontology, " (", data$code, ")**")
  lines[[2]] <- paste0("Comparator cohort *",
      data$ontology,
      "* target cohort")
  lines[[3]] <- paste0("Field in cohortRelationship table: ",
      data$field)
  lines[[4]] <- paste0("Logic: ",
      data$logic)
  lines[[5]] <- paste0("Analysis id: ",
      data$analysisId)
  return(lines)
}
```

## Thirteen basic relationship
There are 13 basic relationships. They are


```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -1)
```

```{r, results='asis', echo = FALSE}
  cat("1)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
  
```{r eval = FALSE}
    |---C----|    
    
                 |----T----| 
```
                      

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -2)
```

```{r, results='asis', echo = FALSE}
  cat("2)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
    
  ```{r eval = FALSE}
    
      |---C---|  
      
              |---T---|  
  ```
                 
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -3)
```

```{r, results='asis', echo = FALSE}
  cat("3)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
    
  ```{r eval = FALSE}
    
        |---C---|  
        
             |---T---|   
  ```
             
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -4)
```

```{r, results='asis', echo = FALSE}
  cat("4)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
    
  ```{r eval = FALSE} 
    
      |-----C-----|  

          |---T---|   
  ```

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -5)
```

```{r, results='asis', echo = FALSE}
  cat("5)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
    
  ```{r eval = FALSE} 
    
      |---C-------| 
        
        |--T----|   
  ```
        
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -6)
```

```{r, results='asis', echo = FALSE}
  cat("6)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  
    
  ```{r eval = FALSE}
      |---C---|  
      
      |------T-------|   
  ```
      
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -7)
```

```{r, results='asis', echo = FALSE}
  cat("7)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  
    
  ```{r eval = FALSE}
        |---C-----|  
        
        |---T-----|   
  ```
        
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -8)
```

```{r, results='asis', echo = FALSE}
  cat("8)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  
    
  ```{r eval = FALSE}
    
      |------C-------|  
      
      |----T-----|   
  ```
      
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -9)
```

```{r, results='asis', echo = FALSE}
  cat("9)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
    
  ```{r eval = FALSE}
        |---C----|
      |------T-------|
   
  ```

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -10)
```

```{r, results='asis', echo = FALSE}
  cat("10)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  
    
  ```{r eval = FALSE}
    
        |---C--------| 
        
      |------T-------|  
  ```
      
      

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -11)
```

```{r, results='asis', echo = FALSE}
  cat("11)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
    
  ```{r eval = FALSE}
    
             |------C-------|  
               
        |----T-----|   
  ```
        
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -12)
```

```{r, results='asis', echo = FALSE}
  cat("12)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```      
    
    
  ```{r eval = FALSE}
                 |------C-------|  
                 
     |-----T-----|   
  ```
      
      
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -13)
```

```{r, results='asis', echo = FALSE}
  cat("13)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  
    
  ```{r eval = FALSE}
    
                      |------C-------|  
      |----T-----|   
  ```
      
    


## Secondary relationships

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -101)
```

```{r, results='asis', echo = FALSE}
  cat("101)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  

  ```{r eval = FALSE}
    |----C-----|
      |------T-------|   cOverlapsT (o)
    
    |----C-----|
      |------T-------|           cDuringT (d)
    
    |----C-----|
      |------T-------|        cStartsT (s)  
  ```

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -102)
```

```{r, results='asis', echo = FALSE}
  cat("102)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```   
  
  ```{r eval = FALSE}
  |----C-----|
  |------T-------|          cStartsT (s)

  |----C-----|              cEqualsT (e)
  |------T---|

  |----C-----|              cIsStartedByT (S)
  |------T-|
  ```
  
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -103)
```

```{r, results='asis', echo = FALSE}
  cat("103)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```    
  
  
  ```{r eval = FALSE}
    |---C----|
  |------T-------|          cDuringT (d)

    |---C--------|
  |------T-------|          cFinishesT (f)
         |------C-------|   
    |----T-----|            cIsOverlappedByT (O)
  ```
  

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -104)
```

```{r, results='asis', echo = FALSE}
  cat("104)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```    
  
  ```{r eval = FALSE}
    |---C--------|           cIsFinishedByT (F)
      |----T-----|

    |------C-----|           cEqualsT (e)
    |------T-----|

    |---C--------|           cFinishesT (f)
  |------T-------|
  ```
  
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -105)
```

```{r, results='asis', echo = FALSE}
  cat("105)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  
  
  ```{r eval = FALSE}
  |----C-----|
                  |------T-------| cPrecedesT(p)

  |----C-----|
             |------T-------|       cMeetsT (m)

    |----C-----|
         |------T-------|         cOverlapsT (o)

  |------C-------|
    |---T--------|                 cIsFinishedByT (F)

  |------C-------|
    |---T----|                     cContainsT (D)
```

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -106)
```

```{r, results='asis', echo = FALSE}
  cat("106)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```    
  
  ```{r eval = FALSE}
    |---C----|
  |------T-------|   cDuringT (d)

    |---C--------|
  |------T-------|   cFinishesT (f)

         |------C-------|
    |----T-----|    cIsOverlappedByT (O)

             |------C-------|
  |----T-----|       CsInTTeInC (M)

                  |------C-------|
  |----T-----|       cPrecededByT (P)
```
    
    
```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -107)
```

```{r, results='asis', echo = FALSE}
  cat("107)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```   
  
  ```{r eval = FALSE}
  |----C-----|
                  |------T-------|   cPrecedesT (p)

  |----C-----|
             |------T-------|        cMeetsT(m)

    |----C-----|
         |------T-------|            cOverlapsT(o)

  |------C-------|
    |---T--------|                   cIsFinishedByT(F)

  |------C-------|
    |---T----|                       cContainsT (D)

  |----C-----|
  |------T-------|                   cStartsT (s)

    |---C-----|
    |---T-----|                      cEqualsT (e)

  |------C-------|
  |----T-----|                       cIsStartedByT(S)

    |---C----|
  |------T-------|                   cDuringT(d)

    |---C--------|
  |------T-------|                   cFinishesT(f)

         |------C-------|
    |----T-----|                     cIsOverlappedByT(O)
```


```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -108)
```

```{r, results='asis', echo = FALSE}
  cat("108)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```        

  ```{r eval = FALSE}
  |----C-----|
                  |------T-------| cPrecedesT (p)


  |----C-----|
             |------T-------| cMeetsT (m)


    |----C-----|
         |------T-------| cOverlapsT (o)

  |----C-----|
  |------T-------|  cStartsT (s)

    |---C----|
  |------T-------|  cDuringT (d)
```


```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -109)
```

```{r, results='asis', echo = FALSE}
  cat("109)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  

  ```{r eval = FALSE}               
  |------C-------|
    |---T----|       cContainsT (D)

  |------C-------|
  |----T-----|       cIsStartedByT (S)

         |------C-------|
    |----T-----|     cIsOverlappedByT (O)

             |------C-------|
  |----T-----|       cIsMetByT (M)

                  |------C-------|
  |----T-----|       cPrecededByT (P)
```

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -110)
```

```{r, results='asis', echo = FALSE}
  cat("110)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  

  ```{r eval = FALSE} 
  
  |----C-----|
  |------T-------|   cStartsT (s)

    |---C-----|
    |---T-----|  cEqualsT (e)

  |------C-------|
  |----T-----|  cIsStartedByT (S)

    |---C----|
  |------T-------| cDuringT (d)

    |---C--------|
  |------T-------| cFinishesT (f)

         |------C-------|
    |----T-----|    cIsOverlappedByT (O)

             |------C-------|
  |----T-----|      cIsMetByT (M)
```

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -111)
```

```{r, results='asis', echo = FALSE}
  cat("111)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 

  ```{r eval = FALSE} 
    |----C-----|
         |------T-------|   cOverlapsT (o)

  |------C-------|
    |---T--------|          cIsFinishedByT(F)

    |----C-----|
    |------T-------|        cStartsT (s)

    |---C-----|
    |---T-----|             cEqualsT (e)

    |----C-----|
 |------T-------|           cDuringT (d)

    |---C--------|
  |------T-------|          cFinishesT (f)
```


```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -112)
```

```{r, results='asis', echo = FALSE}
  cat("112)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
  
  ```{r eval = FALSE} 
  |----C-----|
                  |------T-------|  cPrecedesT (p)

  |----C-----|
             |------T-------|      CeOnTs (m)

    |----C-----|
         |------T-------|-      cOverlapsT (o)

  |------C-------|
    |---T--------|   cIsFinishedByT (F)

  |------C-------|
    |---T----|       cContainsT (D)

  |----C-----|
  |------T-------|    cStartsT (s)

    |---C-----|
    |---T-----|       cEqualsT (e)

  |------C-------|
  |----T-----|     cIsStartedByT (S)
```


```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -113)
```

```{r, results='asis', echo = FALSE}
  cat("113)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 
  
  ```{r eval = FALSE} 

  |----C-----|
                  |------T-------| cPrecedesT (p)

  |----C-----|
             |------T-------|      cMeetsT (m)

    |----C-----|
         |------T-------|          cOverlapsT(o)

  |------C-------|
    |---T--------|                 cIsFinishedByT (F)

  |------C-------|
    |---T----|                     cContainsT (D)

  |----C-----|
  |------T-------|                 cStartsT (s)

    |---C-----|
    |---T-----|                    cEqualsT (e)

  |------C-------|
  |----T-----|                     cIsStartedByT (S)

    |---C----|
  |------T-------|                 cDuringT (d)

    |---C--------|
  |------T-------|                 cFinishesT (f)

         |------C-------|
    |----T-----|                   cIsOverlappedByT (O)

             |------C-------|
  |----T-----|                     cIsMetByT (M)
```


```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -114)
```

```{r, results='asis', echo = FALSE}
  cat("114)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
``` 


  ```{r eval = FALSE} 
  |----C-----|
                  |------T-------|  cPrecedesT (p)

  |----C-----|
             |------T-------|  cMeetsT (m)

    |----C-----|
         |------T-------|  cOverlapsT (o)

  |------C-------|
    |---T--------| cIsFinishedByT (F)

  |----C-----|
  |------T-------|  cStartsT (s)

    |---C-----|
    |---T-----| cEqualsT (e)

    |---C----|
  |------T-------| cDuringT (d)

    |---C--------|
  |------T-------|  cFinishesT (f)
```

```{r tidy=FALSE,eval=TRUE, echo = FALSE}
linesText <- lines(analysisId = -115)
```

```{r, results='asis', echo = FALSE}
  cat("115)", linesText[[1]], "\n")
  cat("\n")
  cat(linesText[[2]], "\n")
  cat("\n")
  cat(linesText[[3]], "\n")
  cat("\n")
  cat(linesText[[4]], "\n")
  cat("\n")
  cat(linesText[[5]], "\n")
```  

  ```{r eval = FALSE}  

    |---C-----|
    |---T-----|             cEqualsT (e)

  |----C-----|
  |------T-------|          cStartsT (s)

    |---C----|
  |------T-------|          cDuringT (d)

    |---C--------|
  |------T-------|          cFinishesT (f)
```


```{r tidy=FALSE, eval=TRUE, echo = FALSE}
ontology
```